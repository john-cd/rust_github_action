name: 'Rust GitHub Action'
description: 'GitHub Action that builds Rust code and creates a thin Docker image'
inputs:
  output-file-name:  # id of input
    description: 'Name of the output file'
    required: true
    default: 'app'
outputs:
  output_file_path:
    description: "Output file path"
    value: ${{ steps.save.outputs.output_file_path }}
runs:
  using: "composite"
  steps:
    - name: Check Runner OS
      if: ${{ runner.os != 'Linux' }}
      shell: bash
      run: |
        echo "::error title=â›” error hint::Support Linux Only"
        exit 1
    # - name: List Paths (debug)
    #   run: |
    #     echo "PATH = $PATH"
    #     echo "Workspace = ${{ github.workspace }}"
    #     echo "Action path = ${{ github.action_path }}"
    #   shell: bash
    ## TODO: if cache_from type=gha does not work, use type=local in compose.yaml and trying the following:
    # - name: Create .cache directory
    #   run: mkdir -p ./.cache/
    # - name: Set up cargo cache
    #   uses: actions/cache@v3
    #   continue-on-error: false
    #   with:
    #     path: ./.cache/
    #     key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    #     restore-keys: ${{ runner.os }}-cargo-
    #
    ## Use docker compose to build
    ## Override part of the docker compose configuration
    - name: Build the container
      run: |
        cat <<EOF
services:
  app:
    build:
      context: ${{ github.workspace }}
      dockerfile: ${{ github.action_path }}/Dockerfile
EOF | docker compose -f ${{ github.action_path }}/compose.yaml -f ${{ github.action_path }}/compose-final.yaml -f - build
      shell: bash
    - name: Display built images (debug)
      run: docker image ls
      shell: bash
    - name: Save the container
      id: save
      run: |
        docker save final-app | zip ${{ inputs.output-file-name }}.tar.zip -
        echo "output_file_path=${{ github.workspace }}/${{ inputs.output-file-name }}.tar.zip" >> "$GITHUB_OUTPUT"
      shell: bash
branding:
  icon: 'package'
  color: 'green'
